# Release & Update Guide

## How Updates Work (Architecture)

```
Cargo.toml (version) → CI build → GitHub Release
  → latest.json uploaded to release assets
  → App launches → silent background check (useAppUpdate hook)
  → check_for_app_update (Rust) → tauri-plugin-updater → latest.json
  → if new version found → AppUpdateBanner appears in UI
  → user clicks "Install & Restart"
  → DMG downloaded, signature verified (tauri-plugin-updater)
  → update applied → app.restart()
```

## Client-Side Update Flow

1. App launches → `useAppUpdate` hook fires a silent background check against `latest.json`
2. If a newer version is found → `AppUpdateBanner` appears at the top of the window (non-blocking)
3. User clicks **Install & Restart** → DMG is downloaded, the cryptographic signature is verified, and the update is installed
4. App restarts automatically into the new version
5. User can click ✕ to dismiss the banner — it will not re-appear until the next launch

## Version Management

- **Single source of truth:** `src-tauri/Cargo.toml` → `[package] version`
- `tauri.conf.json` does **not** contain a `version` field — Tauri CLI reads it from `Cargo.toml` automatically
- `latest.json` on GitHub Releases is a **build artifact**, not a source of truth — it is generated by CI and uploaded automatically

## Developer: How to Cut a Release

1. Update the version in `src-tauri/Cargo.toml`:
   ```toml
   [package]
   version = "X.Y.Z"
   ```
2. Commit the change:
   ```bash
   git commit -am "chore: bump version to X.Y.Z"
   ```
3. Create and push a version tag:
   ```bash
   git tag vX.Y.Z
   git push origin vX.Y.Z
   ```
4. GitHub Actions (`.github/workflows/release.yml`) automatically:
   - Builds and signs the macOS DMG
   - Creates a GitHub Release
   - Generates and uploads `latest.json`
5. Existing users will see the **AppUpdateBanner** on their next app launch

## Signing Keys

- The **private key** lives in the GitHub Actions secret `TAURI_SIGNING_PRIVATE_KEY` — **never commit it to the repository**
- The **public key** is embedded in `src-tauri/tauri.conf.json` under `plugins.updater.pubkey`
- `tauri-plugin-updater` verifies the cryptographic signature before installing any update, protecting users from tampered binaries

### One-time Key Setup

```bash
# Generate keypair (run once locally)
npx @tauri-apps/cli signer generate -w ~/.tauri/skillduck.key

# Copy the public key output into tauri.conf.json → plugins.updater.pubkey
cat ~/.tauri/skillduck.key.pub

# Add the private key to GitHub Actions secrets:
# Secret name: TAURI_SIGNING_PRIVATE_KEY
# Secret value: contents of ~/.tauri/skillduck.key
```

### If the Private Key Is Lost

Generate a new keypair, update `plugins.updater.pubkey` in `tauri.conf.json`, and ship a new release. Users on old versions **cannot** auto-update past a signing key change — they will need to download the new release manually.
